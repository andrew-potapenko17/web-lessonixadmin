{% extends 'home.html' %}
{% load static %}

{% block content %}
<form id="addClassForm" method="post" action="{% url 'addclass' %}">
  {% csrf_token %}
  <div class="mainContent">
    <div class="upper">
      <div class="header">
        <span class="main-title">Add Class</span>
        <div class="students-ico">
          <img src="{% static "img/class-ico.png" %}" alt="students icon"/>
        </div>
      </div>
      <div class="inputs">
        <div class="class-input">
          <p>Class:</p>
          <input type="text" id="class" name="class" required>
        </div>
        <div class="letter-input">
          <p>Letter:</p>
          <input type="text" id="letter" name="letter" required>
        </div>
        <div class="leadteacher-input">
          <p>Class teacher:</p>
          <input type="text" id="leadteacher" name="leadteacher" required>
        </div>
      </div>
    </div>
    <div class="lower">
      <div class="students-header">
        <div class="students-label">
          <img src="{% static "img/student-ico.png" %}" alt="student icon"/>
          <span>Students:</span>
        </div>
        <div class="action-buttons">
          <button type="button" id="openinportform">
            <img src="{% static "img/import-ico.png" %}" alt="import from xlsx" class="action-button"/>
          </button>
          <button type="button" id="openaddstudent">
            <img src="{% static "img/plus-ico.png" %}" alt="add student" class="action-button"/>
          </button>
        </div>
      </div>
      <!-- will be updated via JS -->
      <div class="students-list">
        <!-- Students will be appended here -->
      </div>
      <div class="create-button">
        <button type="submit" class="button">
          <span>Add</span>
        </button>
      </div>
    </div>
  </div>
</form>

<!-- Add Student Modal -->
<div class="addstudent-form modal">
  <form onsubmit="return false;">
    {% csrf_token %}
    <div class="addstudent-body">
      <div class="title">
        <span>Add Student</span>
      </div>
      <div class="input-data">
        <div class="student-image">
          <img src="{% static "img/student-ico.png" %}" alt="student icon"/>
        </div>
        <div class="fullname-input">
          <p>Full Name:</p>
          <input type="text" id="add-fullname" name="fullname">
        </div>
      </div>
      <div class="submit-box">
        <button type="button" class="submit-form">
          <span>Add</span>
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Edit Student Modal -->
<div class="editstudent-form modal">
  <form onsubmit="return false;">
    {% csrf_token %}
    <div class="editstudent-body">
      <div class="title">
        <span>Edit Student</span>
      </div>
      <div class="input-data">
        <div class="student-image">
          <img src="{% static "img/student-ico.png" %}" alt="student icon"/>
        </div>
        <div class="fullname-input">
          <p>Full Name:</p>
          <input type="text" id="edit-fullname" name="fullname">
        </div>
      </div>
      <div class="submit-box">
        <button type="button" class="submit-form">
          <span>Edit</span>
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Delete Student Modal -->
<div class="deletestudent-form modal">
  <div class="deletestudent-body">
    <div class="title-info">
      <span>Are you sure you want to delete this student?</span>
    </div> 
    <div class="buttons-container">
      <button type="button" class="cancel-button">
        <span>Cancel</span>
      </button>
      <button type="button" class="delete-button">
        <span>Yes</span>
      </button>
    </div>
  </div>
</div>

<!-- XLS Import Modal -->
<div class="choosexlxs-form modal">
  <div class="choosexlxs-body">
    <div class="title-info">
      <span>Select a .xlsx file with students</span>
    </div>
    <div class="buttons-container">
      <button type="button" class="upload-button">
        <span>Choose</span>
      </button>
    </div>
  </div>
</div>

<!-- XLS Success Modal -->
<div class="xlxssucces-form modal">
  <div class="xlxssucces-body">
    <div class="title-info">
      <span>[COUNT] students were successfully uploaded</span>
    </div>
    <div class="buttons-container">
      <button type="button" class="ok-button">
        <span>OK</span>
      </button>
    </div>
  </div>
</div>

<!-- XLS Error Modal -->
<div class="xlxserror-form modal">
  <div class="xlxserror-body">
    <div class="title-info">
      <span>Error uploading students</span>
    </div>
    <div class="buttons-container">
      <button type="button" class="ok-button">
        <span>OK</span>
      </button>
    </div>
  </div>
</div>

<link rel="stylesheet" type="text/css" href="{% static 'styles/addclass.css' %}" />

<!-- Include your existing modal open/close JS here -->
<script src="{% static 'js/addclass.js' %}"></script>

<script>
// Local array to store students
let students = [];

// Helper: update students list HTML
function updateStudentList() {
  const listContainer = document.querySelector('.students-list');
  listContainer.innerHTML = '';  // Clear existing list

  students.forEach((student, index) => {
    const studentDiv = document.createElement('div');
    studentDiv.classList.add('singlestudent');

    const nameDiv = document.createElement('div');
    nameDiv.classList.add('student-name');
    const counterSpan = document.createElement('span');
    counterSpan.classList.add('counter');
    counterSpan.textContent = (index + 1) + '.';
    const nameSpan = document.createElement('span');
    nameSpan.classList.add('name');
    nameSpan.textContent = student.fullname;
    nameDiv.appendChild(counterSpan);
    nameDiv.appendChild(nameSpan);

    const buttonsDiv = document.createElement('div');
    buttonsDiv.classList.add('student-buttons');

    const editButton = document.createElement('button');
    editButton.addEventListener('click', () => openEditStudent(index));
    const editImg = document.createElement('img');
    editImg.src = "{% static 'img/edit-ico.png' %}";
    editImg.alt = "edit student";
    editButton.appendChild(editImg);

    const deleteButton = document.createElement('button');
    deleteButton.addEventListener('click', () => openDeleteStudent(index));
    const deleteImg = document.createElement('img');
    deleteImg.src = "{% static 'img/delete-ico.png' %}";
    deleteImg.alt = "delete student";
    deleteButton.appendChild(deleteImg);

    buttonsDiv.appendChild(editButton);
    buttonsDiv.appendChild(deleteButton);

    studentDiv.appendChild(nameDiv);
    studentDiv.appendChild(buttonsDiv);
    listContainer.appendChild(studentDiv);
  });
}

function addStudent() {
  const fullnameInput = document.getElementById('add-fullname');
  const fullname = fullnameInput.value.trim();
  if (fullname !== "") {
    students.push({ fullname: fullname });
    updateStudentList();
    fullnameInput.value = '';
    closeModal('.addstudent-form');
  } else {
    alert("Please enter a full name.");
  }
}

function openEditStudent(index) {
  const student = students[index];
  document.getElementById('edit-fullname').value = student.fullname;
  document.querySelector('.editstudent-form').setAttribute('data-edit-index', index);
  openModal('.editstudent-form');
}

function editStudent() {
  const editInput = document.getElementById('edit-fullname');
  const newName = editInput.value.trim();
  const index = document.querySelector('.editstudent-form').getAttribute('data-edit-index');
  if (newName !== "" && index !== null) {
    students[parseInt(index)] = { fullname: newName };
    updateStudentList();
    closeModal('.editstudent-form');
  } else {
    alert("Please enter a full name.");
  }
}

function openDeleteStudent(index) {
  document.querySelector('.deletestudent-form').setAttribute('data-delete-index', index);
  openModal('.deletestudent-form');
}

function deleteStudent() {
  const index = document.querySelector('.deletestudent-form').getAttribute('data-delete-index');
  if (index !== null) {
    students.splice(parseInt(index), 1);
    updateStudentList();
    closeModal('.deletestudent-form');
  }
}

function importXls() {
  console.log("Import XLS function triggered.");
  openModal('.choosexlxs-form');
}

function handleFormSubmit(event) {
  const form = document.getElementById('addClassForm');
  const oldInputs = form.querySelectorAll('input[name="students"]');
  oldInputs.forEach(input => input.remove());
  students.forEach(student => {
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'students';
    hiddenInput.value = student.fullname;
    form.appendChild(hiddenInput);
  });
}

document.addEventListener('DOMContentLoaded', function () {
  document.getElementById('addClassForm').addEventListener('submit', handleFormSubmit);
  document.getElementById("openaddstudent").addEventListener("click", function () {
    openModal(".addstudent-form");
  });
  document.getElementById("openinportform").addEventListener("click", function () {
    importXls();
  });
  document.querySelector('.addstudent-form .submit-form').addEventListener("click", addStudent);
  document.querySelector('.editstudent-form .submit-form').addEventListener("click", editStudent);
  document.querySelector('.deletestudent-form .delete-button').addEventListener("click", deleteStudent);
  document.querySelector('.deletestudent-form .cancel-button').addEventListener("click", function () {
    closeModal(".deletestudent-form");
  });
});
</script>

{% endblock content %}
